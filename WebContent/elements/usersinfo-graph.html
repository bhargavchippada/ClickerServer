<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="custom-barstat.html">
<polymer-element name="usersinfo-graph" attributes="asyncstop">
	<template>
		<style>
		#toast {
      background-color: #D9534F;
      color: #fff;
    }
    paper-button.bluecls {
      text-transform: inherit;
      background-color: #337ab7;
      color: #fff;
      margin: 0 0 0 0;
    }
		</style>
		<core-ajax
	        url="../QuizStats"
	        params="{{params}}"
	        handleAs="json"
	        response="{{response}}"
	        contentType="application/json"
	        id="coreajax"
	        on-core-response="{{handleResponse}}"
	        error="{{errorresp}}"
	        on-core-error="{{handleError}}"></core-ajax>
	  <div horizontal layout center>
      <div horizontal end-justified layout flex>
        <paper-button id="downqfilebtn" raised class="bluecls" on-click="{{HandleDownloadClick}}">Download</paper-button>
      </div>
    </div>
	  <div id="statsdiv">
	    <template repeat="{{qstat in quizstats}}">
				<custom-barstat heading="{{qstat['title']}}" value="{{qstat['value']}}" color="{{qstat['color']}}"></custom-barstat>
			</template>
		</div>
		<span><paper-toast id="toast" text=""></paper-toast></span>
	</template>
	<script>
	Polymer({
		quizstats:[{"color":"#5bc0de","title":"Test Attempts 1/4 ","value":0},{"color":"#5CB85C","title":"Test Corrects 1/4 ","value":0},{"color":"#D9534F","title":"Test Wrongs 0/4 ","value":0}],
	  fetch:true,
    params:{},
    asyncstop: false,
    ready: function(){
    	if(this.asyncstop){
    		this.params = {};
	      this.params["fetch"] = this.fetch;
	      this.$.coreajax.go();
    	}else this.fetchdata();
    },
    fetchdata: function(){
      this.params = {};
      this.params["fetch"] = this.fetch;
      this.$.coreajax.go();

      this.async(this.fetchdata, null, 3000); 
    },
    handleResponse: function(event, response) {
      if(this.response.status == 1){
        //console.log(this.response.quizstats);
        this.quizstats = JSON.parse(this.response.quizstats);
      }else {
        this.$.toast.text="Authentication failed";
        this.$.toast.show();
      }
    },
    handleError: function(event, response) {
      /*
      if(this.errorresp!=null){
        this.$.toast.text="Connection with server failed!";
        this.$.toast.show();
      }
      */
    },
    HandleDownloadClick: function(){
      //https://thiscouldbebetter.wordpress.com/2012/12/18/loading-editing-and-saving-a-text-file-in-html5-using-javascrip/
      var textToWrite="";
      var jobj={};
      for(var i=0; i<this.quizstats.length;i++){
      	jobj=this.quizstats[i];
      	textToWrite+=jobj['title']+","+jobj['value']+"\n";
      }

      var textFileAsBlob = new Blob([textToWrite], {type:'text/plain'});
      var fileNameToSaveAs = 'usersinfo';

      var downloadLink = document.createElement("a");
      downloadLink.download = fileNameToSaveAs;
      downloadLink.innerHTML = "Download File";
      if (window.URL != null)
      {
        // Chrome allows the link to be clicked
        // without actually adding it to the DOM.
        downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
      }
      else
      {
        // Firefox requires the link to be added to the DOM
        // before it can be clicked.
        downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
        downloadLink.onclick = this.destroyClickedElement;
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
      }

      downloadLink.click();
    },
    destroyClickedElement: function(event)
    {
      document.body.removeChild(event.target);
    }
  })
	</script>
</polymer-element>
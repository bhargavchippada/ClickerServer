<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<polymer-element name="usersinfo-element" attributes="asyncstop">
  <template>
  	<style>
    :host{
      display: block;
      margin: 0 0 32px 0;
    }
    #rowheadings {
      font-weight: 800;
    }
    table {
      width: 100%;
      border-collapse: collapse; 
    }
    tr.border_top {
      width: 100%;
      border-top: 1px solid black;
    }
    td,th {
      text-align: center;
      width: 20%;
      padding: 8px 0 8px 0;
    }
    .label {
      color: #fff;
      padding: 4px;
      border-radius: 4px;
    }
    .bgcolor-grey {
      background-color: #8C8C8C;
    }
    .bgcolor-success {
      background-color: #5CB85C;
    }
    .bgcolor-danger {
      background-color: #D9534F;
    }
    .bgcolor-info {
      background-color: #5bc0de;
    }
    .bgcolor-warning {
      background-color: #f0ad4e;
    }
    .bgcolor-primary {
      background-color: #337ab7;
    }
    .color-grey {
      color: #8C8C8C;
    }
    .color-success {
      color: #5CB85C;
    }
    .color-danger {
      color: #D9534F;
    }
    .color-info {
      color: #5bc0de;
    }
    .color-warning {
      color: #f0ad4e;
    }
    .color-primary {
      color: #337ab7;
    }
    input {
      width: 80%;
    }
    .thinput {
      padding: 0 0 8px 0;
    }
    #toast {
      background-color: #D9534F;
      color: #fff;
    }
    paper-button.bluecls {
      text-transform: inherit;
      background-color: #337ab7;
      color: #fff;
      margin: 0 0 8px 0;
    }
    h3{
      margin:0 0 0 0;
      padding: 0 0 0 0;
      text-align: center;
    }
	  </style>
    <core-ajax
        url="../UsersInfo"
        params="{{params}}"
        handleAs="json"
        response="{{response}}"
        contentType="application/json"
        id="coreajax"
        on-core-response="{{handleResponse}}"
        error="{{errorresp}}"
        on-core-error="{{handleError}}"></core-ajax>
    <div horizontal layout center>
      <h4>{{visiblecount}}/{{usersdata.length}} matches</h4>
      <div horizontal end-justified layout flex>
        <paper-button id="downqfilebtn" raised class="bluecls" on-click="{{HandleDownloadClick}}">Download</paper-button>
      </div>
    </div>
    <table>
      <thead id="tablehead">
        <tr class="border_top">
          <th id="0" on-click="{{changeSort}}" style="{{sortColumn == '0' ? (sortDescending ? 'text-decoration:overline' : 'text-decoration:underline') : ''}}">Rollnumber</th>
          <th id="1" on-click="{{changeSort}}" style="{{sortColumn == '1' ? (sortDescending ? 'text-decoration:overline' : 'text-decoration:underline') : ''}}">Name</th>
          <th id="5" on-click="{{changeSort}}" style="{{sortColumn == '5' ? (sortDescending ? 'text-decoration:overline' : 'text-decoration:underline') : ''}}">Answer</th>
          <th id="2" on-click="{{changeSort}}" style="{{sortColumn == '2' ? (sortDescending ? 'text-decoration:overline' : 'text-decoration:underline') : ''}}">Status</th>
          <th id="3" on-click="{{changeSort}}" style="{{sortColumn == '3' ? (sortDescending ? 'text-decoration:overline' : 'text-decoration:underline') : ''}}">LastUpdate</th>
          <th id="6" hidden?="{{!timed}}" on-click="{{changeSort}}" style="{{sortColumn == '6' ? (sortDescending ? 'text-decoration:overline' : 'text-decoration:underline') : ''}}">TimeTook</th>
        </tr>
        <tr>
          <th class="thinput"><input type="search" value="{{value0}}"/></th>
          <th class="thinput"><input type="search" value="{{value1}}"/></th>
          <th class="thinput"><input type="search" value="{{value2}}"/></th>
          <th class="thinput"><input type="search" value="{{value3}}"/></th>
          <th class="thinput"><input type="search" value="{{value4}}"/></th>
          <th class="thinput" hidden?="{{!timed}}"><input type="search" value="{{value5}}"/></th>
        </tr>
      </thead>
      <tbody id="tablebody">
        <template id="usersinfotemplete" repeat="{{userinfo in usersdata | sortByKey(sortColumn, sortDescending)}}">
          <tr class="border_top" hidden?="{{hiddenornot(userinfo[0],userinfo[1],userinfo[5],getstatus(userinfo[2],userinfo[4]),userinfo[3],userinfo[6], value0, value1, value2, value3, value4, value5)}}">
            <td>{{userinfo[0]}}</td>
            <td>{{userinfo[1]}}</td>
            <td><span class="{{userinfo[4]? 'color-success' : 'color-danger'}}">{{userinfo[5]}}</span></td>
            <td><span class="label {{getstatuscolor(userinfo[2],userinfo[4])}}">{{getstatus(userinfo[2],userinfo[4])}}</span></td>
            <td>{{userinfo[3]}}</td>
            <td hidden?="{{!timed}}">{{userinfo[6]}}</td>
          </tr>
        </template>
      </tbody>
    </table>
    <span><paper-toast id="toast" text="Toast"></paper-toast></span>
  </template>
  <script>
    var jssortColumn = '0';
    var jssortDescending = true;
    Polymer({
      usersdata:[],
      sortColumn:'3',
      sortDescending: true,
      value0:'',
      value1:'',
      value2:'',
      value3:'',
      value4:'',
      value5:'',
      fetch:true,
      params:{},
      timed: true,
      asyncstop: false,
      visiblecount: 0,
      evalVisibleCount: function(){
        var children = this.$.tablebody.querySelectorAll('tr');
        this.visiblecount = 0;
        for(var i=0;i<children.length;i++){
          if(!children[i].hidden) this.visiblecount++;
        }
      },
      value0Changed: function(oldValue, newValue){
        this.value0 = newValue;
        this.async(this.evalVisibleCount);
      },
      value1Changed: function(oldValue, newValue){
        this.value1 = newValue;
        this.async(this.evalVisibleCount);
      },
      value2Changed: function(oldValue, newValue){
        this.value2 = newValue;
        this.async(this.evalVisibleCount);
      },
      value3Changed: function(oldValue, newValue){
        this.value3 = newValue;
        this.async(this.evalVisibleCount);
      },
      value4Changed: function(oldValue, newValue){
        this.value4 = newValue;
        this.async(this.evalVisibleCount);
      },
      value5Changed: function(oldValue, newValue){
        this.value4 = newValue;
        this.async(this.evalVisibleCount);
      },
      ready: function(){
        if(this.asyncstop){
          this.params = {};
          this.params["fetch"] = this.fetch;
          this.$.coreajax.go();
        }else{
          this.fetchdata();
          this.async(this.evalVisibleCount);
        }
      },
      fetchdata: function(){
        this.params = {};
        this.params["fetch"] = this.fetch;
        this.$.coreajax.go();

        this.async(this.fetchdata, null, 3000); 
      },
      changeSort: function(e,p,o){
        var clickedSortColumn = o.id;
        if(clickedSortColumn == this.sortColumn){
          //column already sorted, reverse sort
          this.sortDescending = !this.sortDescending;
        }else{
          this.sortColumn = clickedSortColumn;
        }
      },
      sortByKey : function(array, key, desc) {
        return array.sort(function(a, b) {
          var x = a[key];
          var y = b[key];
          //console.log(key+" "+x+" "+y);
       
          if (typeof x == "string" && typeof y == "string"){
            x = x.toLowerCase(); 
            y = y.toLowerCase();
          }
          if(desc){
            return ((x < y) ? 1 : ((x > y) ? -1 : 0));
          }else{
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
          }
        });
      },
      evalMatch: function(str,val){
        str = JSON.stringify(str).toLowerCase();
        val = val.toLowerCase();
        console.log(val.charAt(0));
        if(val.charAt(0)=='!'){
          var temp = val.substring(1)
          return temp=='' || !(str.indexOf(val.substring(1)) > -1);
        }else return str.indexOf(val) > -1;
      },
      hiddenornot: function(userinfo0,userinfo1,userinfo2,userinfo3,userinfo4,userinfo5,value0,value1,value2,value3,value4,value5){
        //console.log(JSON.stringify(userinfo3));
        var b0 = value0=='' || this.evalMatch(userinfo0,value0);
        var b1 = value1=='' || this.evalMatch(userinfo1,value1);
        var b2 = value2=='' || this.evalMatch(userinfo2,value2);
        var b3 = value3=='' || this.evalMatch(userinfo3,value3);
        var b4 = value4=='' || this.evalMatch(userinfo4,value4);
        var b5 = value5=='' || parseInt(userinfo5) >= parseInt(value5);
        //console.log(b0,b1,b2,b3,b4);
        if(b0 && b1 && b2 && b3 && b4 && b5) {
          return false;
        }else {
          return true;
        }
      },
      resort: function(){
        jssortColumn = this.sortColumn;
        jssortDescending = this.sortDescending;
        console.log(this.usersdata);
        this.usersdata = this.usersdata.sort(function(a, b) {
          var x = a[jssortColumn];
          var y = b[jssortColumn];
       
          console.log(key+" "+x+" "+y);

          if (typeof x == "string"){
            x = x.toLowerCase(); 
            y = y.toLowerCase();
          }
          if(jssortDescending){
            return ((x < y) ? 1 : ((x > y) ? -1 : 0));
          }else{
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
          }
        });
      },
      getstatus : function(statuscode,correct){
        if(statuscode==0) return "Disconnected";
        else if(statuscode==1) return "Connected";
        else if(statuscode==2) return "Attempting";
        else if(statuscode==3) {
          if(correct) return "Correct";
          else return "Wrong";
        }else if(statuscode==4) return "Stopped";
        else return "Invalid";
      },
      getstatuscolor : function(statuscode,correct){
        if(statuscode==0) return "bgcolor-grey";
        else if(statuscode==1) return "bgcolor-info";
        else if(statuscode==2) return "bgcolor-warning";
        else if(statuscode==3) {
          if(correct) return "bgcolor-success";
          else return "bgcolor-danger";
        }else if(statuscode==4) return "bgcolor-primary";
        else return "bgcolor-danger";
      },
      handleResponse: function(event, response) {
        if(this.response.status == 1){
          //console.log(this.response.usersdata);
          this.timed = this.response.timed;
          this.usersdata = JSON.parse(this.response.usersdata);
          this.async(this.evalVisibleCount);
        }else {
          this.$.toast.text="Authentication failed";
          this.$.toast.show();
        }
      },
      handleError: function(event, response) {
        /*
        if(this.errorresp!=null){
          this.$.toast.text="Connection with server failed!";
          this.$.toast.show();
        }
        */
      },
      HandleDownloadClick: function(){
        //https://thiscouldbebetter.wordpress.com/2012/12/18/loading-editing-and-saving-a-text-file-in-html5-using-javascrip/
        var textToWrite="";

        var ths = this.$.tablehead.querySelectorAll('tr')[0].querySelectorAll('th');
        var temp=""
        for (var i=0; i<ths.length; i++) {
          temp+=ths[i].innerHTML;
          if(i!=ths.length-1) temp+=",";
        }
        textToWrite+=temp+"\n";

        var children = this.$.tablebody.querySelectorAll('tr');
        for (var i=0; i<children.length; i++) {
          temp="";
          if(!children[i].hidden) {
            var tds = children[i].querySelectorAll('td');
            for(var j=0; j<tds.length; j++){
              var inner = tds[j].querySelectorAll('span')[0];
              if(inner!=undefined) inner = inner.innerHTML;
              else inner = tds[j].innerHTML;
              temp+=inner;
              if(j!=tds.length-1) temp+=",";
            }
            textToWrite+=temp+"\n";
          }
        }
        //console.log(textToWrite);

        var textFileAsBlob = new Blob([textToWrite], {type:'text/plain'});
        var fileNameToSaveAs = 'usersinfo';

        var downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        if (window.URL != null)
        {
          // Chrome allows the link to be clicked
          // without actually adding it to the DOM.
          downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
        }
        else
        {
          // Firefox requires the link to be added to the DOM
          // before it can be clicked.
          downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
          downloadLink.onclick = this.destroyClickedElement;
          downloadLink.style.display = "none";
          document.body.appendChild(downloadLink);
        }

        downloadLink.click();
      },
      destroyClickedElement: function(event)
      {
        document.body.removeChild(event.target);
      }
    })
  </script>
</polymer-element>
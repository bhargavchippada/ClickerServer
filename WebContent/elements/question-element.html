<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="form-expanding-input.html">
<link rel="import" href="question-option.html">
<link rel="import" href="custom-button.html">
<link rel="import" href="question-textual.html">
<polymer-element name="question-element">
  <template>
    <style>
    	.form-heading {
				font-size: 36px;
				margin: 8px 0 0 0;
			}
			#optionsgroup {
				width: 100%;
			}
			#optionsgroup /deep/ question-option {
				padding :0 0 0 0;
			}
			question-option {
				width: 100%;
			}
			core-icon-button {
				background-color: #F7F7F9;
			}
      paper-toast {
        position: absolute;
        text-align: center;
        background-color: #D9534F;
        bottom: 0 ;
        left: 0;
      }
      paper-button {
        text-transform: inherit;
        background-color: #F7F7F9;
      }
      #truefalsediv {
        margin: 16px 0 16px 0;
      }
      #falsebtn {
        margin: 0 0 0 8px;
      }
    </style>
    <div layout vertical>
    	<p class="form-heading">Question:</p>
    	<form-expanding-input id="questionContent" label="Type Question" error="Type Some Question!" autofocus value="{{qcontent}}"></form-expanding-input>
    	
      <!-- Single and multiple answer multiple choice question template-->
      <template if="{{type<=1}}">
        <div id="optionsgroup">
      		<template repeat="{{qoption, qoptionIndex in optionsList}}">
      			<question-option optionvalue="{{qoption}}" type="{{type}}" id="{{qoptionIndex}}" on-click="{{optionclick}}"></question-option>
      		</template>
      	</div>
        <div layout vertical>
         <span><core-icon-button icon="add" on-click="{{addoption}}">add new option</core-icon-button></span>
        </div>
      </template>

      <!-- true-false -->
      <template if="{{type==2}}">
        <div layout horizontal center-justified id="truefalsediv">
          <paper-button id='1' raised style="{{(tfvalue==1)? 'background-color:#5CB85C; color:#fff' : 'background-color:#F7F7F9;color:#000'}}" on-click="{{toggletf}}">True</paper-button>
          <paper-button id='0' raised style="{{(tfvalue==0)? 'background-color:#D9534F;color:#fff' : 'background-color:#F7F7F9;color:#000'}}" on-click="{{toggletf}}">False</paper-button>
        </div>
      </template>

      <!-- textual answer question template-->
      <template if="{{type==3}}">
        <question-textual id="qtextual" type="{{type}}" value="{{optionsList[0]}}"></question-textual>
      </template>

      <div layout horizontal center-justified>
        <custom-button id="savequiz" togglehtml0="Save Quiz" togglestate='0' on-click="{{savequizclick}}"></custom-button>
        <span><paper-toast id="toast" text="Please select some option!"></paper-toast></span>
      </div>
    </div>
  </template>
  <script type="text/javascript">
    /* question types:
      0:single answer mutliple choice
      1:multiple answer choice
      2:true-false
      3:string answer
      4:numerical answer*
      5:fill in the blanks*
      *optional for now
    */
  	Polymer({
      type:2,
			qcontent: 'dummy question',
      optionsList: ['option1','option2','option3'],
      answersList: [1],
      tfvalue: -1,
  		ready: function() {
        if(this.type<=1){
          var children = this.$.optionsgroup.querySelectorAll('question-option');
          for(var i=0; i<this.answersList.length;i++){
            children[this.answersList[i]].checked=true;
          }
        }
  		},
  		addoption: function(){
  			console.log("add option clicked");
        this.optionsList.push('');
  		},
      savequizclick: function(){
        if(this.type<=1 && this.validateMultipleChoice()){
          console.log(this.qcontent);
          console.log(this.optionsList);
          console.log(this.answersList);
        }else if(this.type==2 && this.validateTrueFalse()){
          console.log(this.qcontent);
          console.log(this.optionsList);
          console.log(this.answersList);
        }else if(this.type==3 && this.validateTextual()){
          console.log(this.qcontent);
          console.log(this.optionsList);
          console.log(this.answersList);
        }
      },
  		validateMultipleChoice: function(){
        //console.log("form validate called");
        var failed = false;
        this.qcontent = this.$.questionContent.value.trim();
        if(this.qcontent==''){
          this.$.questionContent.triggerError();
          failed=true;
        }

        var children = this.$.optionsgroup.querySelectorAll('question-option');
        var optionsList=new Array();
        var answersList=new Array();
        var optionstr;
        for (var i=0; i<children.length; i++) {
          optionstr=children[i].optionvalue;
          if(optionstr.trim()==''){
            children[i].triggerError();
            children[i].optionvalue='';
            failed=true;
          }
          optionsList.push(optionstr);
          if(children[i].checked){
            answersList.push(i);
          }
        }
        if(answersList.length==0){
          this.$.toast.show();
          failed=true;
        }
        if(failed) return false;
        this.optionsList = optionsList;
        this.answersList = answersList;
        //console.log(optionsList);
        //console.log(answersList);
        return true;
  		},
      validateTextual: function(){
        var failed = false;
        this.qcontent = this.$.questionContent.value.trim();
        if(this.qcontent==''){
          this.$.questionContent.triggerError();
          failed=true;
        }

        var answerstr = this.optionsList[0].trim();
        if(answerstr==''){
          this.$.qtextual.triggerError();
          failed=true;
        }
        if(failed) return false;
      
        var optionsList=new Array();
        optionsList.push(answerstr);
        this.optionsList = optionsList;
        this.answersList = new Array();
        return true;
      },
      toggletf: function(e){
        var tfid = e.toElement.id;
        if(this.tfvalue==-1){
          this.tfvalue = tfid;
        }else if(this.tfvalue==1 && tfid=='0'){
          this.tfvalue = 0;
        }else if(this.tfvalue==0 && tfid=='1'){
          this.tfvalue = 1;
        }
      },
      validateTrueFalse: function(){
        var failed = false;
        this.qcontent = this.$.questionContent.value.trim();
        if(this.qcontent==''){
          this.$.questionContent.triggerError();
          failed=true;
        }

        if(this.tfvalue==-1) {
          this.$.toast.show();
          failed=true;
        }

        if(failed) return false;

        var optionsList=new Array();
        var answersList=new Array();
        answersList.push(this.tfvalue);
        this.answersList = answersList;
        return true;
      }
  	})
  </script>
</polymer-element>
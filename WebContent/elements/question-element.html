<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="form-expanding-input.html">
<link rel="import" href="question-option.html">
<link rel="import" href="custom-button.html">
<link rel="import" href="question-textual.html">
<polymer-element name="question-element">
  <template>
    <style>
    	.form-heading {
				font-size: 36px;
				margin: 0 0 0 0;
			}
      #questiontypediv {
        margin: 16px 0 0 0;
      }
			#optionsgroup {
				width: 100%;
			}
			#optionsgroup /deep/ question-option {
				padding :0 0 0 0;
			}
			question-option {
				width: 100%;
			}
			core-icon-button {
				background-color: #F7F7F9;
        margin: 8px 0 0 0;
			}
      paper-toast {
        position: absolute;
        text-align: center;
        background-color: #D9534F;
        bottom: 0 ;
        left: 0;
      }
      paper-button {
        text-transform: inherit;
        background-color: #F7F7F9;
      }
      #truefalsediv {
        margin: 16px 0 16px 0;
      }
      #falsebtn {
        margin: 0 0 0 8px;
      }
      paper-tab {
        font-size: 18px;
        text-align: center;
      }
      paper-tabs.transparent-teal paper-tab::shadow #ink {
        color: #00bcd4;
      }
      paper-tabs.transparent-teal {
        color: #00bcd4;
        margin:0 8px 0 8px;
      }
      paper-tabs.transparent-teal::shadow #selectionBar {
        background-color: #00bcd4;
      }
      paper-tabs.transparent-teal::shadow #selectionBar {
        background-color: #00bcd4;
      }
      paper-tabs paper-tab.core-selected {
        color : #00bcd4;
        font-weight: bold;
      }
      .savedtab {
        color : #5CB85C;
        font-weight: bold;
      }
      paper-tabs paper-tab.savedtab.core-selected{
        color : #5CB85C;
        font-weight: bold;
      }
    </style>
    <div layout vertical>
      <div layout horizontal id="questiontypediv">
        <p class="form-heading">Question:</p>
        <paper-tabs flex id="tabs" selected="{{type}}" self-end class="transparent-teal">
          <paper-tab name='0' id='tab0'>Single</paper-tab>
          <paper-tab name='1' id='tab1'>Multiple</paper-tab>
          <paper-tab name='2' id='tab2'>T/F</paper-tab>
          <paper-tab name='3' id='tab3'>Word</paper-tab>
          <paper-tab name='4' id='tab4'>Short</paper-tab>
        </paper-tabs>
      </div>
    	<form-expanding-input id="questionContent" label="Type Question" error="Type Some Question!" autofocus value="{{qcontent}}"></form-expanding-input>
    	
      <!-- Single and multiple answer multiple choice question template-->
      <div hidden?="{{type>1}}">
        <div id="optionsgroup">
      		<template repeat="{{qoption, qoptionIndex in optionsList}}">
      			<question-option optionvalue="{{qoption}}" type="{{type}}" on-click="{{optionclick}}" checked="{{answersList[qoptionIndex]}}"></question-option>
      		</template>
      	</div>
        <div layout vertical>
         <span><core-icon-button icon="add" on-click="{{addoption}}" active>add new option</core-icon-button></span>
        </div>
      </div>

      <!-- true-false -->
      <div hidden?="{{type!=2}}">
        <div layout horizontal center-justified id="truefalsediv">
          <paper-button id="truebtn" raised style="{{(tfvalue==1)? 'background-color:#5CB85C; color:#fff' : 'background-color:#F7F7F9;color:#000'}}" on-click="{{toggletf}}">True</paper-button>
          <paper-button id="falsebtn" raised style="{{(tfvalue==0)? 'background-color:#D9534F;color:#fff' : 'background-color:#F7F7F9;color:#000'}}" on-click="{{toggletf}}">False</paper-button>
        </div>
      </div>

      <!-- textual answer question template-->
      <div hidden?="{{type!=3}}">
        <question-textual id="qtextual" type="{{type}}" value="{{textvalue}}"></question-textual>
      </div>

      <div layout horizontal center-justified>
        <custom-button id="savequiz" togglehtml0="Save Quiz" togglestate='0' on-click="{{savequizclick}}"></custom-button>
        <span><paper-toast id="toast" text=""></paper-toast></span>
      </div>
    </div>
  </template>
  <script type="text/javascript">
    /* question types:
      0:single answer mutliple choice
      1:multiple answer choice
      2:true-false
      3:string answer
      4:numerical answer*
      5:fill in the blanks*
      *optional for now
    */
  	Polymer({
      type:0,
      qcontent: 'dummy question',
      optionsList: ['option1','option2','option3'],
      answersList: [false,true,false],
      tfvalue: -1,
      textvalue: 'answerok',
      savedqcontent: '',
      savedOptionsList: [],
      savedAnswersList: [],
      savedquiztype: -1,
  		ready: function() {
        console.log("ready called");
  		},
  		addoption: function(){
  			console.log("add option clicked");
        this.optionsList.push('');
        this.answersList.push(false);
  		},
      savequizclick: function(){
        console.log("save quiz called");

        if(this.type<=1 && this.validateMultipleChoice()){
        }else if(this.type==2 && this.validateTrueFalse()){
        }else if(this.type==3 && this.validateTextual()){
        }else return;

        if(this.savedquiztype!=-1) this.$.tabs.querySelector("#tab"+this.savedquiztype).className="";
        this.$.tabs.querySelector("#tab"+this.type).setAttribute("class", "savedtab");
        this.savedquiztype = this.type;
        this.savedqcontent = this.qcontent;

        console.log("Saved quiz: ");
        console.log(this.savedquiztype);
        console.log(this.savedqcontent);
        console.log(this.savedOptionsList);
        console.log(this.savedAnswersList);
      },
  		validateMultipleChoice: function(){
        console.log("Multiple validation called");

        var failed = false;
        this.qcontent = this.$.questionContent.value.trim();
        if(this.qcontent==''){
          this.$.questionContent.triggerError();
          failed=true;
        }

        var children = this.$.optionsgroup.querySelectorAll('question-option');
        var optionsList=new Array();
        var answersList=new Array();
        var optionstr;
        var numofoptionstrue = 0;
        for (var i=0; i<children.length; i++) {
          optionstr=children[i].optionvalue;
          if(optionstr.trim()==''){
            children[i].triggerError();
            children[i].optionvalue='';
            failed=true;
          }
          optionsList.push(optionstr);
          if(children[i].checked){
            answersList.push(true);
            numofoptionstrue++;
          }else{
            answersList.push(false);
          }
        }
        if(numofoptionstrue==0){
          this.$.toast.text="Please select some option!";
          this.$.toast.show();
          failed=true;
        }
        if(failed) return false;

        this.optionsList = optionsList;
        this.answersList = answersList;

        this.savedOptionsList = JSON.parse(JSON.stringify(this.optionsList));
        this.savedAnswersList = JSON.parse(JSON.stringify(this.answersList));

        //console.log(optionsList);
        //console.log(answersList);
        return true;
  		},
      validateTextual: function(){
        console.log("textual validation called");

        var failed = false;
        this.qcontent = this.$.questionContent.value.trim();
        if(this.qcontent==''){
          this.$.questionContent.triggerError();
          failed=true;
        }

        var answerstr = this.textvalue.trim();
        if(answerstr==''){
          this.$.qtextual.triggerError();
          failed=true;
        }
        if(failed) return false;
        
        var textanswer=new Array();
        textanswer.push(answerstr);
        this.savedOptionsList = new Array();
        this.savedAnswersList = textanswer;

        return true;
      },
      toggletf: function(e){
        console.log("toggletf called");

        var tfid;
        if(e.toElement.id=="falsebtn"){
          tfid=0;
        }else tfid=1;

        if(this.tfvalue==-1){
          this.tfvalue = tfid;
        }else if(this.tfvalue==1 && tfid==0){
          this.tfvalue = 0;
        }else if(this.tfvalue==0 && tfid==1){
          this.tfvalue = 1;
        }
      },
      validateTrueFalse: function(){
        console.log("tf validation called");

        var failed = false;
        this.qcontent = this.$.questionContent.value.trim();
        if(this.qcontent==''){
          this.$.questionContent.triggerError();
          failed=true;
        }

        if(this.tfvalue==-1) {
          this.$.toast.text="Please select true or false!";
          this.$.toast.show();
          failed=true;
        }

        if(failed) return false;

        var answertf=new Array();
        answertf.push(this.tfvalue);
        this.savedOptionsList = new Array();
        this.savedAnswersList = answertf;

        return true;
      },
      typeChanged: function(oldValue, newValue){
        console.log("yo: " + oldValue + " " + newValue);
        if(newValue==0){
          var checkedid = -1;
          for(var i=0; i<this.answersList.length;i++){
            if(this.answersList[i] && checkedid==-1) checkedid = i;
            else if(this.answersList[i]) this.answersList[i]=false;
          }
        }

        if(newValue==this.savedquiztype){
          if(newValue<=1){
            this.qcontent = this.savedqcontent;
            this.optionsList = JSON.parse(JSON.stringify(this.savedOptionsList));
            this.answersList = JSON.parse(JSON.stringify(this.savedAnswersList));
          }else if(newValue==2){
            this.tfvalue = JSON.parse(JSON.stringify(this.savedAnswersList[0]));
          }else if(newValue==3){
            this.textvalue = JSON.parse(JSON.stringify(this.savedAnswersList[0]));
          }
        }
        
        /*
        console.log("Temporary: ")
        console.log(this.qcontent);
        console.log(this.optionsList);
        console.log(this.answersList);
        console.log(this.tfvalue);
        console.log(this.textvalue);
  `     */
      }
  	})
  </script>
</polymer-element>